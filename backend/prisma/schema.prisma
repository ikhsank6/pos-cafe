// This is your Prisma schema file for Cafe POS System
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & AUTHORIZATION ====================

model User {
  id                   Int            @id @default(autoincrement())
  uuid                 String         @unique @default(uuid())
  username             String         @unique
  email                String         @unique
  password             String
  fullName             String         @map("full_name")
  phone                String?
  avatar               String?
  isActive             Boolean        @default(false) @map("is_active")
  verifiedAt           DateTime?      @map("verified_at")
  verificationToken    String?        @unique @map("verification_token")
  resetPasswordToken   String?        @unique @map("reset_password_token")
  resetPasswordExpires DateTime?      @map("reset_password_expires")
  activeRoleId         Int?           @map("active_role_id")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  activeRole            Role?          @relation("ActiveRole", fields: [activeRoleId], references: [id])
  userRoles             UserRole[]
  refreshTokens         RefreshToken[]
  triggeredNotifications Notification[]      @relation("NotificationFromUser")
  
  @@map("users")
}

model RefreshToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique
  userId    Int       @map("user_id")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Role {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  name        String   @unique
  code        String   @unique // OWNER, MANAGER, CASHIER, KITCHEN, WAITER
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  activeUsers     User[] @relation("ActiveRole")
  userRoles       UserRole[]
  menuAccess      MenuAccess[]
  notifications   Notification[]
  
  @@map("roles")
}

model UserRole {
  id     Int @id @default(autoincrement())
  uuid   String @unique @default(uuid())
  userId Int @map("user_id")
  roleId Int @map("role_id")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Menu {
  id       Int     @id @default(autoincrement())
  uuid     String  @unique @default(uuid())
  name     String
  path     String?
  icon     String?
  parentId Int?    @map("parent_id")
  order    Int     @default(0)
  isActive Boolean @default(true) @map("is_active")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  parent     Menu?        @relation("MenuHierarchy", fields: [parentId], references: [id])
  children   Menu[]       @relation("MenuHierarchy")
  menuAccess MenuAccess[]
  
  @@map("menus")
}

model MenuAccess {
  id     Int @id @default(autoincrement())
  uuid   String @unique @default(uuid())
  roleId Int @map("role_id")
  menuId Int @map("menu_id")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, menuId])
  @@index([roleId])
  @@index([menuId])
  @@map("menu_access")
}

model Notification {
  id          Int       @id @default(autoincrement())
  uuid        String    @unique @default(uuid())
  toRoleId    Int       @map("to_role_id")    // Target role to receive notification
  fromUserId  Int?      @map("from_user_id")  // User who triggered the notification (nullable for system notifications)
  message     String                           // Notification message
  detailUrl   String?   @map("detail_url")    // URL to navigate when clicked
  referenceId String?   @map("reference_id")  // Reference ID (e.g., order UUID, product UUID)
  type        String    @default("info")       // info, success, warning, error
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  toRole   Role  @relation(fields: [toRoleId], references: [id])
  fromUser User? @relation("NotificationFromUser", fields: [fromUserId], references: [id])
  
  @@index([toRoleId])
  @@index([isRead])
  @@index([fromUserId])
  @@map("notifications")
}

// ==================== MEDIA ====================

model Media {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid())
  filename      String
  originalName  String    @map("original_name")
  mimeType      String    @map("mime_type")
  size          Int
  path          String
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")
  createdBy     String?   @map("created_by")
  updatedBy     String?   @map("updated_by")
  deletedBy     String?   @map("deleted_by")
  
  // Relations
  products      Product[]

  @@map("media")
}

// ==================== PRODUCT MANAGEMENT ====================

model Category {
  id          Int     @id @default(autoincrement())
  uuid        String  @unique @default(uuid())
  name        String  @unique
  description String?
  icon        String?
  isActive    Boolean @default(true) @map("is_active")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  products Product[]
  
  @@map("categories")
}

model Product {
  id          Int         @id @default(autoincrement())
  uuid        String      @unique @default(uuid())
  sku         String      @unique
  name        String
  description String?
  categoryId  Int         @map("category_id")
  price       Decimal     @db.Decimal(10, 2)
  cost        Decimal?    @db.Decimal(10, 2)
  stock       Int         @default(0)
  minStock    Int         @default(0) @map("min_stock")
  unit        String      @default("pcs")
  image       String?
  mediaId     Int?        @map("media_id")
  isActive    Boolean     @default(true) @map("is_active")
  type        ProductType @default(FOOD)
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  category   Category        @relation(fields: [categoryId], references: [id])
  media      Media?          @relation(fields: [mediaId], references: [id])
  orderItems OrderItem[]
  stockMoves StockMovement[]
  
  @@index([categoryId])
  @@index([sku])
  @@index([mediaId])
  @@map("products")
}

enum ProductType {
  FOOD
  BEVERAGE
  SNACK
  OTHER
}

// ==================== STOCK MANAGEMENT ====================

model StockMovement {
  id        Int          @id @default(autoincrement())
  uuid      String       @unique @default(uuid())
  productId Int          @map("product_id")
  type      MovementType
  quantity  Int
  notes     String?
  reference String?      // Reference to supplier invoice, waste form, etc.
  
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  product Product @relation(fields: [productId], references: [id])
  
  @@index([productId])
  @@index([createdAt])
  @@map("stock_movements")
}

enum MovementType {
  IN          // Stock masuk (pembelian)
  OUT         // Stock keluar (penjualan)
  ADJUSTMENT  // Penyesuaian stock
  WASTE       // Barang rusak/expired
  RETURN      // Retur
}

// ==================== TABLE MANAGEMENT ====================

model Table {
  id       Int         @id @default(autoincrement())
  uuid     String      @unique @default(uuid())
  number   String      @unique
  capacity Int
  location String?     // Indoor, Outdoor, VIP
  status   TableStatus @default(AVAILABLE)
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  orders Order[]
  
  @@map("tables")
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

// ==================== ORDER MANAGEMENT ====================

model Order {
  id            Int         @id @default(autoincrement())
  uuid          String      @unique @default(uuid())
  orderNumber   String      @unique @map("order_number")
  tableId       Int?        @map("table_id")
  customerId    Int?        @map("customer_id")
  customerName  String?     @map("customer_name")
  customerPhone String?     @map("customer_phone")
  type          OrderType   @default(DINE_IN)
  status        OrderStatus @default(PENDING)
  subtotal      Decimal     @default(0) @db.Decimal(10, 2)
  tax           Decimal     @default(0) @db.Decimal(10, 2)
  discount      Decimal     @default(0) @db.Decimal(10, 2)
  discountId    Int?        @map("discount_id")
  total         Decimal     @default(0) @db.Decimal(10, 2)
  notes         String?
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  table        Table?        @relation(fields: [tableId], references: [id])
  customer     Customer?     @relation(fields: [customerId], references: [id])
  discountCode Discount?     @relation(fields: [discountId], references: [id])
  orderItems   OrderItem[]
  transactions Transaction[]
  
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([customerId])
  @@index([tableId])
  @@map("orders")
}

enum OrderType {
  DINE_IN
  TAKE_AWAY
  DELIVERY
}

enum OrderStatus {
  PENDING     // Pesanan baru
  CONFIRMED   // Dikonfirmasi
  PREPARING   // Sedang diproses dapur
  READY       // Siap disajikan
  SERVED      // Sudah disajikan
  COMPLETED   // Selesai dan dibayar
  CANCELLED   // Dibatalkan
}

model OrderItem {
  id        Int             @id @default(autoincrement())
  uuid      String          @unique @default(uuid())
  orderId   Int             @map("order_id")
  productId Int             @map("product_id")
  quantity  Int
  price     Decimal         @db.Decimal(10, 2)
  subtotal  Decimal         @db.Decimal(10, 2)
  notes     String?         // Special request (extra pedas, tanpa es, dll)
  status    OrderItemStatus @default(PENDING)
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

// ==================== PAYMENT & TRANSACTION ====================

model Transaction {
  id            Int               @id @default(autoincrement())
  uuid          String            @unique @default(uuid())
  orderId       Int               @map("order_id")
  transactionNo String            @unique @map("transaction_no")
  paymentMethod PaymentMethod     @map("payment_method")
  amount        Decimal           @db.Decimal(10, 2)
  paidAmount    Decimal           @map("paid_amount") @db.Decimal(10, 2)
  changeAmount  Decimal           @default(0) @map("change_amount") @db.Decimal(10, 2)
  status        TransactionStatus @default(PENDING)
  notes         String?
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  order   Order @relation(fields: [orderId], references: [id])
  
  @@index([transactionNo])
  @@index([orderId])
  @@index([createdAt])
  @@map("transactions")
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  E_WALLET
  QRIS
  BANK_TRANSFER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ==================== CUSTOMER MANAGEMENT ====================

model Customer {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid())
  name          String
  email         String?   @unique
  phone         String    @unique
  address       String?
  dateOfBirth   DateTime? @map("date_of_birth")
  loyaltyPoints Int       @default(0) @map("loyalty_points")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  orders Order[]

  @@index([phone])
  @@index([email])
  @@map("customers")
}

// ==================== DISCOUNT & PROMOTION ====================

model Discount {
  id          Int          @id @default(autoincrement())
  uuid        String       @unique @default(uuid())
  code        String       @unique
  name        String
  description String?
  type        DiscountType
  value       Decimal      @db.Decimal(10, 2) // Percentage or fixed amount
  minPurchase Decimal?     @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount Decimal?     @map("max_discount") @db.Decimal(10, 2)
  startDate   DateTime     @map("start_date")
  endDate     DateTime     @map("end_date")
  isActive    Boolean      @default(true) @map("is_active")
  usageLimit  Int?         @map("usage_limit")
  usageCount  Int          @default(0) @map("usage_count")
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")
  deletedBy String?   @map("deleted_by")

  // Relations
  orders Order[]

  @@index([code])
  @@index([isActive])
  @@map("discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}
